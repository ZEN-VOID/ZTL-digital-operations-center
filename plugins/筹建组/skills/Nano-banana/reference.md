# Nano Banana API è¯¦ç»†å‚è€ƒ

> æœ¬æ–‡æ¡£æä¾›Nano Bananaè¡ç”Ÿå›¾ç”Ÿæˆçš„å®Œæ•´APIå‚æ•°è¯´æ˜ã€é…ç½®é€‰é¡¹å’ŒæŠ€æœ¯ç»†èŠ‚ã€‚

## ğŸ“¡ APIæ¦‚è¿°

### åŸºç¡€ä¿¡æ¯

- **æ¨¡å‹**: Nano Banana v1
- **æä¾›å•†**: OpenRouter (google/gemini-2.5-flash-image-preview)
- **ç«¯ç‚¹**: `https://openrouter.ai/api/v1/chat/completions`
- **è®¤è¯æ–¹å¼**: Bearer Token (API Key)
- **è¾“å…¥æ ¼å¼**: Multimodal (Text + Image)
- **è¾“å‡ºæ ¼å¼**: Base64ç¼–ç çš„PNGå›¾åƒ

### æŠ€æœ¯ç‰¹æ€§

| ç‰¹æ€§ | è§„æ ¼ |
|------|------|
| è¾“å…¥åˆ†è¾¨ç‡ | ä»»æ„ï¼ˆå»ºè®®â‰¥512x512ï¼‰ |
| è¾“å‡ºåˆ†è¾¨ç‡ | 1024x1024 |
| è¾“å‡ºæ ¼å¼ | PNGï¼ˆæ— æŸï¼‰|
| å¹³å‡ç”Ÿæˆæ—¶é—´ | 16.5ç§’ |
| æœ€å¤§å¹¶å‘æ•° | 8ä¸ªè¯·æ±‚ |
| è¶…æ—¶è®¾ç½® | 60ç§’ |

## âš™ï¸ æ ¸å¿ƒå‚æ•°è¯¦è§£

### 1. variation_instructionï¼ˆå˜åŒ–æŒ‡ä»¤ï¼‰

å®Œæ•´çš„å˜åŒ–æŒ‡ä»¤å¯¹è±¡åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```json
{
  "description": "string",           // å˜åŒ–çš„ç®€çŸ­æè¿°
  "keep_consistent": ["string"],     // ä¿æŒä¸€è‡´çš„å…ƒç´ åˆ—è¡¨
  "change_elements": ["string"],     // éœ€è¦æ”¹å˜çš„å…ƒç´ åˆ—è¡¨
  "nano_banana_parameters": {        // Nano Bananaç‰¹å®šå‚æ•°
    "strength": 0.65,                // å˜åŒ–å¼ºåº¦ (0.4-0.8)
    "prompt_weight": "string"        // æç¤ºè¯æƒé‡å¢å¼º
  }
}
```

#### 1.1 descriptionï¼ˆå¿…éœ€ï¼‰

**ç±»å‹**: `string`
**è¯´æ˜**: å¯¹æœ¬æ¬¡å˜åŒ–çš„ç®€çŸ­æè¿°ï¼Œç”¨äºæ–‡ä»¶å‘½åå’Œæ—¥å¿—è®°å½•

**ç¤ºä¾‹**:
```json
"description": "è§’è‰²è½¬èº«åŠ¨ä½œ"
"description": "è¡¨æƒ…å˜åŒ–-å¾®ç¬‘"
"description": "åœºæ™¯å…‰çº¿è°ƒæ•´"
```

#### 1.2 keep_consistentï¼ˆå¿…éœ€ï¼‰

**ç±»å‹**: `array<string>`
**è¯´æ˜**: å¿…é¡»ä¿æŒä¸€è‡´çš„å…ƒç´ åˆ—è¡¨ï¼Œè‡³å°‘åŒ…å«1ä¸ªå…ƒç´ 

**å¸¸è§å…ƒç´ ç±»åˆ«**:

1. **è§’è‰²ç‰¹å¾**:
   ```json
   ["è§’è‰²æœè£…", "å‘å‹ç‰¹å¾", "é¢éƒ¨ç‰¹å¾", "ä½“å‹ç‰¹å¾"]
   ```

2. **é£æ ¼ç‰¹å¾**:
   ```json
   ["èµ›åšæœ‹å…‹é£æ ¼", "ç”»é£", "è‰²è°ƒ", "è´¨æ„Ÿ", "å…‰å½±æ•ˆæœ"]
   ```

3. **åœºæ™¯ç‰¹å¾**:
   ```json
   ["èƒŒæ™¯åœºæ™¯", "ç¯å¢ƒæ°›å›´", "å¤©æ°”çŠ¶æ€", "æ—¶é—´è®¾å®š"]
   ```

**æœ€ä½³å®è·µ**:
- âœ… æè¿°å…·ä½“: "è§’è‰²çš„é»‘è‰²çš®å¤¹å…‹" è€Œé "è¡£æœ"
- âœ… åˆ†å±‚æè¿°: è§’è‰²â†’æœè£…â†’ç»†èŠ‚
- âŒ é¿å…æ¨¡ç³Š: "æ•´ä½“æ„Ÿè§‰" âŒ

#### 1.3 change_elementsï¼ˆå¿…éœ€ï¼‰

**ç±»å‹**: `array<string>`
**è¯´æ˜**: éœ€è¦æ”¹å˜çš„å…ƒç´ åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åº”æ¸…æ™°æè¿°å˜åŒ–æ–¹å‘

**æ ¼å¼å»ºè®®**:
```
"[å…ƒç´ ç±»åˆ«]: [å˜åŒ–æ–¹å‘]"
```

**ç¤ºä¾‹**:

1. **å§¿æ€åŠ¨ä½œ**:
   ```json
   [
     "èº«ä½“å§¿æ€: ä»æ­£é¢è½¬ä¸ºä¾§é¢",
     "å¤´éƒ¨è§’åº¦: å¾®å¾®è½¬å‘å³ä¾§",
     "æ‰‹è‡‚ä½ç½®: è‡ªç„¶æ‘†åŠ¨"
   ]
   ```

2. **è¡¨æƒ…å˜åŒ–**:
   ```json
   [
     "é¢éƒ¨è¡¨æƒ…: ä»å¹³é™å˜ä¸ºå¾®ç¬‘",
     "çœ¼ç¥: æ›´åŠ æ¸©å’Œ",
     "å˜´è§’: å¾®å¾®ä¸Šæ‰¬"
   ]
   ```

3. **åœºæ™¯å˜åŒ–**:
   ```json
   [
     "å…‰çº¿æ–¹å‘: ä»æ­£é¢æ”¹ä¸ºä¾§é¢",
     "ç¯å¢ƒäº®åº¦: ç¨å¾®è°ƒæš—",
     "èƒŒæ™¯è™šåŒ–: å¢å¼ºæ™¯æ·±æ•ˆæœ"
   ]
   ```

**æœ€ä½³å®è·µ**:
- âœ… æè¿°å…·ä½“: "èº«ä½“è§’åº¦ä»æ­£é¢è½¬ä¸ºå³ä¾§45åº¦"
- âœ… åŒ…å«æ–¹å‘: "ä»...åˆ°..." æˆ– "å¢å¼º/å‡å¼±"
- âœ… ä¸€æ¬¡ä¸“æ³¨: ä¸è¦åŒæ—¶å˜åŒ–å¤ªå¤šç»´åº¦
- âŒ é¿å…å†²çª: å˜åŒ–ä¸è¦ä¸keep_consistenté‡å 

#### 1.4 strengthï¼ˆå˜åŒ–å¼ºåº¦ï¼‰

**ç±»å‹**: `float`
**èŒƒå›´**: `0.4 - 0.8`
**é»˜è®¤å€¼**: `0.6`

**å¼ºåº¦åˆ†çº§è¡¨**:

| å¼ºåº¦èŒƒå›´ | å˜åŒ–ç¨‹åº¦ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| 0.4-0.5 | è½»å¾® | è¡¨æƒ…å¾®è°ƒã€è§†è§’å¾®è°ƒ | å¾®ç¬‘â†’æµ…ç¬‘ |
| 0.5-0.6 | ä¸­è½» | å°å¹…å§¿æ€å˜åŒ– | æ­£é¢â†’è½»å¾®ä¾§é¢ |
| 0.6-0.7 | ä¸­ç­‰ | æ˜æ˜¾å§¿æ€ã€åŠ¨ä½œå˜åŒ– | ç«™ç«‹â†’è¡Œèµ° |
| 0.7-0.8 | è¾ƒå¤§ | åœºæ™¯å…ƒç´ ã€å…‰å½±å˜åŒ– | ç™½å¤©â†’é»„æ˜ |

**è°ƒå‚å»ºè®®**:
```python
# ä¿å®ˆç­–ç•¥ï¼šä»ä½å€¼å¼€å§‹å°è¯•
strength = 0.55  # å…ˆæµ‹è¯•ä½å¼ºåº¦
# å¦‚æœå˜åŒ–ä¸å¤Ÿæ˜æ˜¾ï¼Œå†é€æ­¥æé«˜
strength = 0.65
strength = 0.75

# æ¿€è¿›ç­–ç•¥ï¼šå¿«é€Ÿè¿­ä»£ï¼ˆä¸æ¨èï¼‰
strength = 0.75  # å¯èƒ½ä¸¢å¤±ä¸€è‡´æ€§
```

#### 1.5 prompt_weightï¼ˆæç¤ºè¯æƒé‡å¢å¼ºï¼‰

**ç±»å‹**: `string`ï¼ˆå¯é€‰ï¼‰
**è¯´æ˜**: ç”¨äºå¢å¼ºæŸäº›å˜åŒ–æ–¹å‘çš„æç¤ºè¯ï¼Œè¾…åŠ©AIç†è§£

**ä½¿ç”¨åœºæ™¯**:
- å¼ºè°ƒç‰¹å®šåŠ¨ä½œ: `"turning around, dynamic twist"`
- å¼ºè°ƒæƒ…ç»ªè¡¨ç°: `"happy smile, warm expression"`
- å¼ºè°ƒç‰©ç†ç‰¹æ€§: `"natural motion, realistic movement"`

**ç¤ºä¾‹**:
```json
{
  "change_elements": ["èº«ä½“è½¬èº«åŠ¨ä½œ"],
  "prompt_weight": "turning around, smooth rotation, natural body mechanics"
}
```

**æ³¨æ„**: è¯¥å­—æ®µä¸ºè¾…åŠ©æ€§è´¨ï¼Œä¸»è¦ä¾èµ–change_elementsçš„æè¿°ã€‚

### 2. execution_configï¼ˆæ‰§è¡Œé…ç½®ï¼‰

æ‰¹é‡ç”Ÿæˆçš„æ‰§è¡Œé…ç½®ï¼š

```json
{
  "batch_size": 2,                // æ¯æ‰¹å¤„ç†æ•°é‡
  "max_concurrent_requests": 2,   // æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
  "retry_attempts": 3,            // å¤±è´¥é‡è¯•æ¬¡æ•°
  "retry_delay_seconds": 5        // é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
}
```

#### 2.1 batch_size

**ç±»å‹**: `int`
**èŒƒå›´**: `1-10`
**é»˜è®¤å€¼**: `2`
**è¯´æ˜**: æ¯æ‰¹å¤„ç†çš„ä»»åŠ¡æ•°é‡

**å»ºè®®å€¼**:
- å¿«é€Ÿæµ‹è¯•: `1-2`
- æ­£å¸¸ç”Ÿäº§: `2-4`
- å¤§æ‰¹é‡: `5-8`

#### 2.2 max_concurrent_requests

**ç±»å‹**: `int`
**èŒƒå›´**: `1-8`
**é»˜è®¤å€¼**: `2`
**è¯´æ˜**: åŒæ—¶æ‰§è¡Œçš„APIè¯·æ±‚æ•°

**æ€§èƒ½å½±å“**:
```
å¹¶å‘æ•° = 2: 2å¼ å›¾ Ã— 16.5ç§’ = ~33ç§’
å¹¶å‘æ•° = 4: 4å¼ å›¾ Ã— 16.5ç§’ = ~33ç§’ï¼ˆå¹¶è¡Œï¼‰
å¹¶å‘æ•° = 8: 8å¼ å›¾ Ã— 16.5ç§’ = ~33ç§’ï¼ˆå¹¶è¡Œï¼‰
```

**é™åˆ¶å› ç´ **:
- APIé…é¢é™åˆ¶
- ç½‘ç»œå¸¦å®½
- æœ¬åœ°å†…å­˜

#### 2.3 retry_attempts

**ç±»å‹**: `int`
**èŒƒå›´**: `0-5`
**é»˜è®¤å€¼**: `3`
**è¯´æ˜**: ä»»åŠ¡å¤±è´¥æ—¶çš„æœ€å¤§é‡è¯•æ¬¡æ•°

**é‡è¯•è§¦å‘æ¡ä»¶**:
- APIè¯·æ±‚è¶…æ—¶
- ç½‘ç»œè¿æ¥é”™è¯¯
- æœåŠ¡å™¨ä¸´æ—¶é”™è¯¯ (5xx)
- é™æµé”™è¯¯ (429)

**ä¸é‡è¯•çš„é”™è¯¯**:
- å‚æ•°éªŒè¯å¤±è´¥ (400)
- è®¤è¯å¤±è´¥ (401)
- é…é¢è€—å°½ (402)

### 3. api_configï¼ˆAPIé…ç½®ï¼‰

```json
{
  "endpoint": "https://openrouter.ai/api/v1/chat/completions",
  "model": "google/gemini-2.5-flash-image-preview",
  "timeout_seconds": 60,
  "api_key": "sk-or-v1-xxx"  // ä»ç¯å¢ƒå˜é‡è¯»å–
}
```

#### 3.1 endpoint

**ç±»å‹**: `string`
**é»˜è®¤å€¼**: `"https://openrouter.ai/api/v1/chat/completions"`
**è¯´æ˜**: OpenRouter APIç«¯ç‚¹

#### 3.2 model

**ç±»å‹**: `string`
**é»˜è®¤å€¼**: `"google/gemini-2.5-flash-image-preview"`
**è¯´æ˜**: ä½¿ç”¨çš„æ¨¡å‹æ ‡è¯†ç¬¦

**æ›¿ä»£æ¨¡å‹**:
- `google/gemini-2.5-flash`: æ›´å¿«ä½†å›¾åƒè´¨é‡ç•¥ä½
- `google/gemini-2.0-flash-exp`: å®éªŒæ€§ç‰ˆæœ¬

#### 3.3 timeout_seconds

**ç±»å‹**: `int`
**èŒƒå›´**: `30-120`
**é»˜è®¤å€¼**: `60`
**è¯´æ˜**: APIè¯·æ±‚è¶…æ—¶æ—¶é—´

**å»ºè®®å€¼**:
- å¿«é€Ÿæµ‹è¯•: `30ç§’`
- æ­£å¸¸ä½¿ç”¨: `60ç§’`
- å¤æ‚ä»»åŠ¡: `90-120ç§’`

## ğŸ“‹ å®Œæ•´é…ç½®ç¤ºä¾‹

### å•ä»»åŠ¡é…ç½®

```json
{
  "plan_id": "nano-character-turn-20251019",
  "agent_id": "Nano-banana",
  "execution_config": {
    "batch_size": 1,
    "max_concurrent_requests": 1,
    "retry_attempts": 3
  },
  "api_config": {
    "model": "google/gemini-2.5-flash-image-preview",
    "timeout_seconds": 60
  },
  "batches": [
    {
      "batch_id": 1,
      "tasks": [
        {
          "task_id": "turn-001",
          "reference_image": "output/project/character-base.png",
          "variation_instruction": {
            "description": "è§’è‰²è½¬èº«åŠ¨ä½œ",
            "keep_consistent": [
              "èµ›åšæœ‹å…‹é£æ ¼",
              "è§’è‰²æœè£…",
              "å‘å‹ç‰¹å¾"
            ],
            "change_elements": [
              "èº«ä½“å§¿æ€: ä»æ­£é¢è½¬ä¸ºä¾§é¢"
            ],
            "nano_banana_parameters": {
              "strength": 0.65,
              "prompt_weight": "turning around, natural motion"
            }
          }
        }
      ]
    }
  ]
}
```

### æ‰¹é‡ä»»åŠ¡é…ç½®

```json
{
  "plan_id": "nano-expression-batch-20251019",
  "agent_id": "Nano-banana",
  "execution_config": {
    "batch_size": 2,
    "max_concurrent_requests": 2,
    "retry_attempts": 3
  },
  "batches": [
    {
      "batch_id": 1,
      "tasks": [
        {
          "task_id": "expr-smile",
          "reference_image": "base.png",
          "variation_instruction": {
            "description": "å¾®ç¬‘è¡¨æƒ…",
            "keep_consistent": ["å§¿æ€", "èƒŒæ™¯"],
            "change_elements": ["è¡¨æƒ…: å¾®ç¬‘"],
            "nano_banana_parameters": {
              "strength": 0.50
            }
          }
        },
        {
          "task_id": "expr-surprise",
          "reference_image": "base.png",
          "variation_instruction": {
            "description": "æƒŠè®¶è¡¨æƒ…",
            "keep_consistent": ["å§¿æ€", "èƒŒæ™¯"],
            "change_elements": ["è¡¨æƒ…: æƒŠè®¶"],
            "nano_banana_parameters": {
              "strength": 0.55
            }
          }
        }
      ]
    }
  ]
}
```

## ğŸš¨ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|-------|------|---------|
| 400 | å‚æ•°éªŒè¯å¤±è´¥ | æ£€æŸ¥é…ç½®æ–‡ä»¶æ ¼å¼ |
| 401 | è®¤è¯å¤±è´¥ | æ£€æŸ¥API Key |
| 402 | é…é¢ä¸è¶³ | å……å€¼æˆ–ç­‰å¾…é…é¢æ¢å¤ |
| 429 | è¯·æ±‚è¿‡äºé¢‘ç¹ | é™ä½å¹¶å‘æ•°æˆ–å¢åŠ å»¶è¿Ÿ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | ç¨åé‡è¯• |
| 504 | è¯·æ±‚è¶…æ—¶ | å¢åŠ timeoutæˆ–ç¨åé‡è¯• |

### é”™è¯¯æ—¥å¿—æ ¼å¼

```json
{
  "error_type": "API_ERROR",
  "error_code": 429,
  "error_message": "Rate limit exceeded",
  "task_id": "turn-001",
  "timestamp": "2025-10-19T10:30:00Z",
  "retry_count": 1,
  "max_retries": 3
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘ä¼˜åŒ–

```python
# å°æ‰¹é‡é«˜å¹¶å‘
execution_config = {
    "batch_size": 2,
    "max_concurrent_requests": 4  # æ¯æ‰¹2ä¸ªä»»åŠ¡ï¼ŒåŒæ—¶å¤„ç†2æ‰¹
}

# å¤§æ‰¹é‡ä¸­å¹¶å‘
execution_config = {
    "batch_size": 4,
    "max_concurrent_requests": 2
}
```

### 2. ç½‘ç»œä¼˜åŒ–

```python
# ä½¿ç”¨æœ¬åœ°å‚è€ƒå›¾åƒï¼ˆé¿å…ä¸Šä¼ å¤§æ–‡ä»¶ï¼‰
reference_image = "/local/path/image.png"

# ç»“æœä¿å­˜åˆ°æœ¬åœ°ï¼ˆé¿å…ç½‘ç»œä¼ è¾“ï¼‰
output_path = "/local/output/"
```

### 3. æˆæœ¬ä¼˜åŒ–

```python
# ä½¿ç”¨é€‚å½“çš„strengthå€¼ï¼ˆé¿å…å¤šæ¬¡é‡è¯•ï¼‰
strength = 0.60  # ä»ä¸­ç­‰å€¼å¼€å§‹

# æ‰¹é‡ç”Ÿæˆå‡å°‘å›ºå®šå¼€é”€
batch_size = 4   # è€Œéæ¯æ¬¡1ä¸ª
```

## ğŸ”’ å®‰å…¨ä¸é™åˆ¶

### è¾“å…¥éªŒè¯

```python
# å‚è€ƒå›¾åƒéªŒè¯
- æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
- æ–‡ä»¶å¤§å°é™åˆ¶: <10MB
- æ ¼å¼æ£€æŸ¥: PNG/JPG/JPEG
- åˆ†è¾¨ç‡æ£€æŸ¥: â‰¥512x512

# å‚æ•°éªŒè¯
- strengthèŒƒå›´: 0.4-0.8
- keep_consistentéç©º
- change_elementséç©º
```

### é…é¢ç®¡ç†

```python
# é¢„ä¼°æˆæœ¬
estimated_credits = num_tasks * 5  # æ¯å¼ å›¾çº¦5ç§¯åˆ†

# é¢„ç®—æ£€æŸ¥
if estimated_credits > budget_limit:
    request_user_confirmation()
```

### æ•°æ®éšç§

- å‚è€ƒå›¾åƒä»…ç”¨äºç”Ÿæˆï¼Œä¸ä¼šè¢«ä¿å­˜åˆ°æœåŠ¡å™¨
- ç”Ÿæˆç»“æœè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°outputç›®å½•
- API Keyä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œä¸ä¼šè¢«è®°å½•åˆ°æ—¥å¿—

---

**ç‰ˆæœ¬**: 2.0.0
**æ›´æ–°æ—¥æœŸ**: 2025-10-19
