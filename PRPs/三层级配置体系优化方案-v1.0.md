# 三层级CLAUDE.md配置体系优化方案

> **版本**: v1.0.0
> **创建时间**: 2025-10-23
> **优化目标**: 明确三层级配置边界,优化B/N/M命令功能,确保系统一致性

---

## 📋 目录

1. [优化背景](#优化背景)
2. [现状分析](#现状分析)
3. [三层级配置边界定义](#三层级配置边界定义)
4. [B/N/M命令优化方案](#bnm命令优化方案)
5. [实施计划](#实施计划)
6. [验证标准](#验证标准)

---

## 优化背景

### 用户需求

基于用户明确提出的优化要求:

```yaml
核心诉求:
  1. N指令中应添加对当前项目系统级框架的描述
  2. commands作为系统级指令也从属于N指令的更新
  3. M指令中需要新增项目级plugins相关的内容
  4. CLAUDE.md中不需要更新日志 ✅ (已完成)
  5. 仔细分析思考B/N/M指令和对应的三层级CLAUDE文档的关系
  6. 分析三层级文档应该配置的内容结构
  7. 整体优化整个系统
```

### 已完成工作

✅ **阶段一: 清理更新日志**
- 机器级CLAUDE.md: 移除更新日志章节
- 系统级CLAUDE.md: 移除版本历史章节
- 项目级CLAUDE.md: 移除版本标记和更新日志

---

## 现状分析

### 三层级配置体系现状

```yaml
机器级 (~/.claude/CLAUDE.md):
  管理命令: /B (v3.1.0)
  当前内容:
    - ✅ 1. 配置层级说明
    - ✅ 2. Claude Code核心概念 (Subagents/Skills/Commands)
    - ✅ 3. 三者对比与分野
    - ✅ 4. 全局最佳实践
    - ✅ 5. 跨项目通用规范
    - ✅ 6. 复杂系统三层架构规范
    - ✅ 7. 工具和插件配置

  核心定位:
    - Claude Code官方概念和使用规范
    - 跨所有项目和框架的通用知识
    - 全局工具和插件配置说明

  问题诊断: ✅ 内容定位准确,无需调整

系统级 (.claude/CLAUDE.md):
  管理命令: /N (v3.3.0)
  当前内容:
    - ✅ 1. 系统概述
    - ✅ 2. 系统AGENTS说明 (F系列)
    - ✅ 3. 系统COMMANDS说明 (A-Z单字母命令)
    - ✅ 4. 三层架构标准
    - ✅ 5. 执行流程标准
    - ✅ 6. Agents与Skills关系
    - ✅ 7. 目录结构规范
    - ✅ 8. 开发标准

  核心定位:
    - ZTL数智化作战中心框架级配置
    - F系列通用框架智能体说明
    - 系统级命令说明

  问题诊断:
    - ⚠️ 缺少"当前项目系统级框架的描述"
    - ⚠️ Commands说明未明确强调从属于N命令管理
    - ❓ 是否需要添加系统级plugins配置?

项目级 (CLAUDE.md):
  管理命令: /M (v3.3.0)
  当前内容:
    - ✅ 1. 项目概述
    - ✅ 1.1 开发物料管理规范
    - ✅ 2. 项目AGENTS说明 (G/X/E/R/M/Z系列)
    - ✅ 3. 意图分析图谱
    - ✅ 4. 项目快捷键系统

  核心定位:
    - 餐饮行业数智化管理平台业务配置
    - 业务智能体说明
    - 业务意图路由

  问题诊断:
    - ❓ M命令v3.3.0已添加Functionality 6(项目级plugins扫描),但CLAUDE.md中未体现
    - ⚠️ 缺少"项目级plugins配置"章节
```

### B/N/M命令现状

```yaml
/B命令 (机器级配置管理):
  版本: v3.1.0
  核心功能:
    1. 内容分类器 (5大类别智能分类)
    2. Plugins扫描器 (扫描~/.claude/settings.json)
    3. 学习记录管理器
    4. 备份恢复机制
    5. 手动内容添加

  状态: ✅ 功能完整,无需调整

/N命令 (系统级配置管理):
  版本: v3.3.0
  核心功能:
    1. F系列智能体扫描器
    2. 系统命令扫描器 (A-Z单字母)
    3. 命令分类器 (上下文/执行/代码三类)
    4. 自动备份恢复

  状态:
    - ⚠️ 缺少"框架描述生成"功能
    - ⚠️ 命令说明未强调从属关系
    - ❓ 是否需要系统级plugins扫描?

/M命令 (项目级配置管理):
  版本: v3.3.0
  核心功能:
    1. 项目智能体扫描器 (G/X/E/R/M/Z系列)
    2. 项目命令扫描器
    3. 业务矩阵生成器
    4. 意图分析图谱生成器
    5. 目录结构扫描器
    6. Functionality 6: 项目级plugins扫描器 ✅ (v3.3.0新增)

  状态:
    - ✅ 已添加plugins扫描功能
    - ⚠️ CLAUDE.md模板未包含plugins章节
    - 需要: 验证功能是否正常工作
```

---

## 三层级配置边界定义

### 配置边界矩阵

| 配置维度 | 机器级 (~/.claude/) | 系统级 (.claude/) | 项目级 (根目录) |
|---------|-------------------|-----------------|--------------|
| **作用范围** | 所有项目和框架 | 特定框架/模板 | 单一项目业务 |
| **管理命令** | /B | /N | /M |
| **优先级** | 最低(兜底) | 中等 | 最高(覆盖) |
| **Agents类型** | - | F系列框架智能体 | G/X/E/R/M/Z业务智能体 |
| **Commands类型** | - | A-Z单字母系统命令 | 业务专用命令 |
| **Plugins配置** | 全局MCP/Skills | 框架级插件(可选) | 项目级插件 |
| **核心内容** | Claude Code概念 | 框架架构标准 | 业务规则配置 |

### 内容归属原则

```yaml
机器级配置内容:
  核心原则: "通用概念、全局规范、跨项目知识"

  应该包含:
    ✅ Claude Code官方概念 (Subagents/Skills/Commands)
    ✅ 三者对比与使用场景决策树
    ✅ 全局最佳实践 (命名/目录/文档/版本控制)
    ✅ 跨项目通用规范 (工具使用/上下文管理/安全权限)
    ✅ 复杂系统三层架构规范 (Layer 1/2/3)
    ✅ 全局工具和插件配置 (MCP服务器/Anthropic Skills)

  不应该包含:
    ❌ 特定框架的架构设计
    ❌ 特定项目的业务规则
    ❌ 框架/项目特定的智能体
    ❌ 框架/项目特定的命令

系统级配置内容:
  核心原则: "框架定义、系统能力、通用工具"

  应该包含:
    ✅ 框架定位与技术栈说明 (NEW! 用户需求)
    ✅ 系统AGENTS说明 (F系列框架智能体)
    ✅ 系统COMMANDS说明 (A-Z系统命令,从属于/N管理) (ENHANCED! 用户需求)
    ✅ 三层架构标准 (Layer定义)
    ✅ 执行流程标准 (通用流程/AIGC流程)
    ✅ Agents与Skills关系
    ✅ 目录结构规范
    ✅ 开发标准
    ❓ 系统级plugins配置 (可选,若框架有特定插件需求)

  不应该包含:
    ❌ Claude Code官方概念定义 (属于机器级)
    ❌ 项目业务规则
    ❌ 业务智能体 (G/X/E/R/M/Z)
    ❌ 项目特定命令

项目级配置内容:
  核心原则: "业务定位、项目规则、团队约定"

  应该包含:
    ✅ 项目概述与业务矩阵
    ✅ 开发物料管理规范
    ✅ 项目AGENTS说明 (G/X/E/R/M/Z业务智能体)
    ✅ 项目级plugins配置 (NEW! 用户需求)
    ✅ 意图分析图谱 (业务路由)
    ✅ 项目快捷键系统

  不应该包含:
    ❌ Claude Code官方概念 (属于机器级)
    ❌ 框架架构标准 (属于系统级)
    ❌ 系统智能体 (F系列,属于系统级)
    ❌ 系统命令 (A-Z,属于系统级)
```

---

## B/N/M命令优化方案

### /N命令优化 (系统级)

#### 优化1: 添加"框架描述生成"功能

**用户需求**: "N指令中应添加对当前项目系统级框架的描述"

**实施方案**:

```python
class FrameworkDescriptionGenerator:
    """系统级框架描述生成器"""

    def generate_framework_description(self) -> str:
        """
        生成框架描述章节,包含:
        1. 框架定位与核心价值
        2. 技术架构栈
        3. 智能体生态概览
        4. MCP服务集成
        5. 适用场景
        """

        # 步骤1: 扫描项目根目录CLAUDE.md获取项目定位
        project_info = self._extract_project_info()

        # 步骤2: 分析F系列智能体,提炼框架能力
        framework_capabilities = self._analyze_f_series_agents()

        # 步骤3: 扫描.claude/skills/,识别框架级技能包
        framework_skills = self._scan_framework_skills()

        # 步骤4: 生成框架描述
        return self._render_framework_description(
            project_info,
            framework_capabilities,
            framework_skills
        )
```

**输出示例**:

```markdown
## 系统概述

### 框架定位

ZTL数智化作战中心基于Claude Code框架,采用**智能体编排+能力包执行**的分层架构:

- **核心价值**: 为餐饮行业提供从战略到执行的全链路数智化支持
- **技术基础**: Claude Sonnet 4.5 + MCP生态 + 多智能体协作
- **应用场景**: 战略规划、品牌营销、数据分析、行政管理、运营中台、门店筹建、系统开发

### 框架能力矩阵

| 能力域 | F系列智能体 | 核心功能 |
|-------|-----------|---------|
| 智能体工程 | F1 | Agents创建与优化 |
| 命令系统 | F2 | Commands设计与开发 |
| 事件驱动 | F3 | Hooks钩子系统 |
| 技能包开发 | F5 | Skills创建与管理 |
| API工具 | F6 | 三层架构API标准化 |
| ... | ... | ... |

### 系统级技能包

| 技能包 | 功能定位 | 适用场景 |
|-------|---------|---------|
| aigc/ | AIGC图像生成能力 | 创意组V3-V6智能体调用 |
| figma/ | Figma设计集成 | 设计工作流自动化 |
```

**位置**: 插入到系统级CLAUDE.md的"系统概述"章节

#### 优化2: 强化Commands从属关系

**用户需求**: "commands作为系统级指令也从属于N指令的更新"

**实施方案**:

在系统级CLAUDE.md的"系统COMMANDS说明"章节开头添加明确说明:

```markdown
## 系统COMMANDS说明

> **管理说明**: 本章节内容由`/N`命令自动扫描生成和维护
> **扫描范围**: `.claude/commands/`目录下所有A-Z单字母命令文件
> **更新方式**: 执行`/N`命令自动同步最新的系统命令列表和描述

系统命令是框架级的工作流快捷键,适用于所有基于本框架的项目...
```

**N.md命令文件修改**:

```python
# 在生成COMMANDS章节时添加管理说明
def _generate_commands_section(self) -> str:
    header = """
## 系统COMMANDS说明

> **管理说明**: 本章节内容由`/N`命令自动扫描生成和维护
> **扫描范围**: `.claude/commands/`目录下所有A-Z单字母命令文件
> **更新方式**: 执行`/N`命令自动同步最新的系统命令列表和描述

"""
    # ... 继续生成命令列表
```

#### 优化3: 系统级Plugins配置 (可选)

**分析**:
- 当前系统级CLAUDE.md未包含plugins配置
- 机器级已有全局plugins配置
- 项目级M命令已有plugins扫描功能

**建议**:
- 如果框架有特定的必需插件(如某个MCP服务器是框架运行必需),可在系统级配置
- 如果无框架特定插件,可省略此章节

**实施**: 暂不实施,保持现状

---

### /M命令优化 (项目级)

#### 验证1: Plugins扫描功能

**现状**: M.md v3.3.0已添加Functionality 6: 项目级plugins扫描器

```python
# M.md中已有的代码
class ProjectPluginsScanner:
    def scan_plugins(self) -> Dict[str, any]:
        """
        扫描.claude/settings.json中的插件配置
        返回: {
            "has_config": bool,
            "anthropic_skills": [...],
            "mcp_servers": [...]
        }
        """
```

**验证步骤**:
1. 检查`.claude/settings.json`是否存在
2. 执行M命令,检查是否正确扫描插件
3. 查看生成的CLAUDE.md是否包含plugins章节

#### 优化1: 添加Plugins章节到CLAUDE.md模板

**用户需求**: "M指令中需要新增项目级plugins相关的内容"

**实施方案**:

在M.md的CLAUDE.md模板中添加新章节:

```python
def _generate_plugins_section(self, plugins_data: Dict) -> str:
    """生成项目级Plugins配置章节"""

    if not plugins_data.get('has_config'):
        return ""  # 无配置文件,不生成章节

    return f"""
---

## 5. 项目级Plugins配置

### 5.1 Anthropic Agent Skills

当前项目已启用的官方插件包:

{self._render_anthropic_skills(plugins_data['anthropic_skills'])}

### 5.2 MCP服务器集成

当前项目已集成的MCP服务器:

{self._render_mcp_servers(plugins_data['mcp_servers'])}

### 5.3 插件使用说明

插件使用策略和最佳实践参见[机器级配置文档](~/.claude/CLAUDE.md#7-工具和插件配置)
"""
```

**章节位置**: 在"项目快捷键系统"之后,"附录"之前

---

### /B命令优化 (机器级)

**分析**: /B命令功能已完整,无需调整

**状态**: ✅ 保持现状

---

## 实施计划

### 阶段一: N命令优化 (优先级: 高)

```yaml
任务1: 添加FrameworkDescriptionGenerator
  文件: .claude/commands/N.md
  修改内容:
    - 新增FrameworkDescriptionGenerator类
    - 实现generate_framework_description()方法
    - 在CLAUDE.md模板中插入框架描述章节

  预期输出:
    - 系统级CLAUDE.md新增"框架定位"小节
    - 包含技术架构栈说明
    - 包含框架能力矩阵
    - 包含系统级技能包列表

任务2: 强化Commands从属关系
  文件: .claude/commands/N.md
  修改内容:
    - 在_generate_commands_section()中添加管理说明header
    - 明确标注命令由/N管理

  预期输出:
    - 系统级CLAUDE.md的Commands章节开头有明确管理说明

任务3: 执行测试
  步骤:
    1. 执行 /N 命令
    2. 检查生成的.claude/CLAUDE.md
    3. 验证新增内容正确性
```

### 阶段二: M命令优化与验证 (优先级: 中)

```yaml
任务1: 验证Plugins扫描功能
  步骤:
    1. 检查.claude/settings.json存在性
    2. 执行 /M 命令
    3. 检查返回的plugins_data结构
    4. 验证是否正确解析enabledPlugins和mcpServers

  预期: Functionality 6正常工作

任务2: 添加Plugins章节模板
  文件: .claude/commands/M.md
  修改内容:
    - 新增_generate_plugins_section()方法
    - 在CLAUDE.md模板中插入第5章
    - 实现anthropic_skills和mcp_servers渲染

  预期输出:
    - 项目级CLAUDE.md新增"5. 项目级Plugins配置"章节
    - 包含已启用的Anthropic Skills列表
    - 包含已集成的MCP服务器列表

任务3: 执行测试
  步骤:
    1. 执行 /M 命令
    2. 检查生成的CLAUDE.md
    3. 验证第5章内容正确性
```

### 阶段三: 系统一致性验证 (优先级: 低)

```yaml
验证项:
  1. 三层级CLAUDE.md内容边界清晰
  2. B/N/M命令功能无重复
  3. 配置覆盖原则正确 (项目级 > 系统级 > 机器级)
  4. 所有自动生成章节有管理说明
  5. 无更新日志残留

测试场景:
  - 新建项目: 执行 /N + /M,检查生成的CLAUDE.md
  - 修改智能体: 执行对应命令,检查更新是否正确
  - Plugins变更: 修改settings.json,执行命令,检查同步
```

---

## 验证标准

### 功能验证清单

#### /N命令验证

- [ ] 执行`/N`后,`.claude/CLAUDE.md`包含"框架定位"小节
- [ ] "框架定位"包含技术架构栈说明
- [ ] "框架定位"包含F系列能力矩阵
- [ ] "框架定位"包含系统级技能包列表(如aigc/)
- [ ] "系统COMMANDS说明"章节开头有管理说明
- [ ] 管理说明明确标注"由/N命令自动扫描生成和维护"
- [ ] 命令列表完整,包含所有A-Z单字母命令
- [ ] 命令分类正确(上下文/执行/代码三类)

#### /M命令验证

- [ ] 执行`/M`后,`CLAUDE.md`包含"5. 项目级Plugins配置"章节
- [ ] Plugins章节包含"5.1 Anthropic Agent Skills"小节
- [ ] 正确列出已启用的插件(如document-skills, example-skills)
- [ ] Plugins章节包含"5.2 MCP服务器集成"小节
- [ ] 正确列出已集成的MCP服务器(如chrome-mcp, lark-mcp等)
- [ ] 每个插件/服务器有功能说明和使用场景
- [ ] 如果无.claude/settings.json,不生成Plugins章节

#### 系统一致性验证

- [ ] 机器级CLAUDE.md: 只包含Claude Code官方概念和全局规范
- [ ] 系统级CLAUDE.md: 只包含框架定义和F系列智能体
- [ ] 项目级CLAUDE.md: 只包含业务规则和G/X/E/R/M/Z智能体
- [ ] 三层级文档均无"更新日志"章节
- [ ] 三层级文档均无版本号标记
- [ ] 每层文档末尾有"文档维护"和"更新命令"说明

---

## 附录

### 参考资料

- 用户原始需求
- N.md命令文件 (v3.3.0)
- M.md命令文件 (v3.3.0)
- B.md命令文件 (v3.1.0)
- 机器级CLAUDE.md
- 系统级CLAUDE.md
- 项目级CLAUDE.md

### 变更影响评估

```yaml
影响范围:
  /N命令:
    - 代码修改: 中等 (新增FrameworkDescriptionGenerator类)
    - 文档修改: 小 (系统级CLAUDE.md新增框架描述)
    - 向后兼容: ✅ 是 (纯新增功能,不影响现有逻辑)

  /M命令:
    - 代码修改: 小 (新增_generate_plugins_section方法)
    - 文档修改: 小 (项目级CLAUDE.md新增第5章)
    - 向后兼容: ✅ 是 (Functionality 6已存在,只是输出模板增强)

  /B命令:
    - 代码修改: 无
    - 文档修改: 无
    - 向后兼容: ✅ 是

风险评估:
  - 低风险: 新增功能不影响现有逻辑
  - 测试充分: 每个阶段都有明确的验证标准
  - 可回滚: 所有修改都有备份,可快速恢复
```

---

**文档状态**: 方案设计完成,待实施
**下一步**: 开始阶段一 - N命令优化
