#!/usr/bin/env python3
"""
PPTç»„è£…å™¨

å°†æˆªå›¾ç»„è£…æˆPPT,æ”¯æŒè´¨é‡éªŒè¯å’Œå…ƒæ•°æ®åµŒå…¥ã€‚
"""

from pathlib import Path
from typing import List, Dict, Optional
from pptx import Presentation
from pptx.util import Inches
from PIL import Image
from datetime import datetime


def create_ppt_from_screenshots(
    screenshot_dir: Path,
    output_ppt: Path,
    pattern: str = "slide_*.png",
    slide_width: float = 10.0,
    slide_height: float = 5.625,
    title: Optional[str] = None,
    author: Optional[str] = None
) -> Dict[str, any]:
    """
    å°†æˆªå›¾ç»„è£…æˆPPT

    Args:
        screenshot_dir: æˆªå›¾ç›®å½•
        output_ppt: è¾“å‡ºPPTè·¯å¾„
        pattern: æ–‡ä»¶åŒ¹é…æ¨¡å¼
        slide_width: å¹»ç¯ç‰‡å®½åº¦(è‹±å¯¸)
        slide_height: å¹»ç¯ç‰‡é«˜åº¦(è‹±å¯¸)
        title: PPTæ ‡é¢˜(å…ƒæ•°æ®)
        author: ä½œè€…(å…ƒæ•°æ®)

    Returns:
        ç»“æœå­—å…¸,åŒ…å«åˆ›å»ºçš„é¡µæ•°ã€æ–‡ä»¶è·¯å¾„ç­‰ä¿¡æ¯
    """
    # è·å–æ‰€æœ‰æˆªå›¾
    screenshots = sorted(screenshot_dir.glob(pattern))

    if not screenshots:
        raise ValueError(f"No screenshots found in {screenshot_dir} with pattern {pattern}")

    print(f"ğŸ“¸ æ‰¾åˆ° {len(screenshots)} å¼ æˆªå›¾\n")

    # åˆ›å»ºPPT
    prs = Presentation()

    # è®¾ç½®å¹»ç¯ç‰‡å°ºå¯¸
    prs.slide_width = Inches(slide_width)
    prs.slide_height = Inches(slide_height)

    # è®¾ç½®å…ƒæ•°æ®
    if title:
        prs.core_properties.title = title
    if author:
        prs.core_properties.author = author

    prs.core_properties.comments = f"Generated by html-to-ppt skill at {datetime.now().isoformat()}"

    # è·å–ç©ºç™½ç‰ˆå¼
    blank_slide_layout = prs.slide_layouts[6]

    # æ·»åŠ æ¯å¼ æˆªå›¾ä¸ºä¸€é¡µå¹»ç¯ç‰‡
    for screenshot in screenshots:
        print(f"  â• æ·»åŠ : {screenshot.name}")

        # åˆ›å»ºæ–°å¹»ç¯ç‰‡
        slide = prs.slides.add_slide(blank_slide_layout)

        # æ·»åŠ å›¾ç‰‡,å¡«æ»¡æ•´ä¸ªå¹»ç¯ç‰‡
        slide.shapes.add_picture(
            str(screenshot),
            left=0,
            top=0,
            width=Inches(slide_width),
            height=Inches(slide_height)
        )

    # ä¿å­˜PPT
    prs.save(str(output_ppt))

    file_size_mb = output_ppt.stat().st_size / (1024 * 1024)

    print(f"\nâœ… PPTå·²ç”Ÿæˆ: {output_ppt}")
    print(f"ğŸ“Š å…± {len(screenshots)} é¡µ")
    print(f"ğŸ“¦ æ–‡ä»¶å¤§å°: {file_size_mb:.2f}MB\n")

    return {
        "output_path": str(output_ppt),
        "slide_count": len(screenshots),
        "file_size_mb": round(file_size_mb, 2),
        "screenshots": [str(s) for s in screenshots]
    }


def validate_screenshots(
    screenshot_dir: Path,
    pattern: str = "slide_*.png",
    expected_width: int = 1920,
    min_height: int = 800
) -> Dict[str, any]:
    """
    éªŒè¯æˆªå›¾è´¨é‡

    Args:
        screenshot_dir: æˆªå›¾ç›®å½•
        pattern: æ–‡ä»¶åŒ¹é…æ¨¡å¼
        expected_width: é¢„æœŸå®½åº¦
        min_height: æœ€å°é«˜åº¦

    Returns:
        éªŒè¯ç»“æœå­—å…¸
    """
    screenshots = sorted(screenshot_dir.glob(pattern))

    if not screenshots:
        return {
            "valid": False,
            "errors": ["No screenshots found"],
            "warnings": [],
            "results": []
        }

    errors = []
    warnings = []
    results = []

    for screenshot in screenshots:
        img = Image.open(screenshot)
        width, height = img.size

        result = {
            "name": screenshot.name,
            "width": width,
            "height": height,
            "valid": True,
            "errors": []
        }

        # æ£€æŸ¥å®½åº¦
        if width != expected_width:
            error_msg = f"Width {width} != expected {expected_width}"
            result['errors'].append(error_msg)
            result['valid'] = False
            errors.append(f"{screenshot.name}: {error_msg}")

        # æ£€æŸ¥é«˜åº¦
        if height < min_height:
            warning_msg = f"Height {height} < minimum {min_height}"
            result['errors'].append(warning_msg)
            result['valid'] = False
            warnings.append(f"{screenshot.name}: {warning_msg}")

        results.append(result)

    return {
        "valid": len(errors) == 0,
        "errors": errors,
        "warnings": warnings,
        "results": results,
        "total": len(screenshots),
        "valid_count": sum(1 for r in results if r['valid'])
    }


def validate_ppt(
    ppt_path: Path,
    expected_slide_count: int,
    max_file_size_mb: float = 50.0
) -> Dict[str, any]:
    """
    éªŒè¯PPTè´¨é‡

    Args:
        ppt_path: PPTæ–‡ä»¶è·¯å¾„
        expected_slide_count: é¢„æœŸå¹»ç¯ç‰‡æ•°é‡
        max_file_size_mb: æœ€å¤§æ–‡ä»¶å¤§å°(MB)

    Returns:
        éªŒè¯ç»“æœå­—å…¸
    """
    if not ppt_path.exists():
        return {
            "valid": False,
            "errors": ["PPT file not found"],
            "warnings": []
        }

    prs = Presentation(str(ppt_path))

    errors = []
    warnings = []

    # éªŒè¯å¹»ç¯ç‰‡æ•°é‡
    actual_count = len(prs.slides)
    if actual_count != expected_slide_count:
        errors.append(
            f"Slide count {actual_count} != expected {expected_slide_count}"
        )

    # éªŒè¯å¹»ç¯ç‰‡å°ºå¯¸ (16:9)
    expected_width = Inches(10)
    expected_height = Inches(5.625)

    if prs.slide_width != expected_width:
        warnings.append(f"Slide width {prs.slide_width} != {expected_width}")

    if prs.slide_height != expected_height:
        warnings.append(f"Slide height {prs.slide_height} != {expected_height}")

    # éªŒè¯æ–‡ä»¶å¤§å°
    file_size_mb = ppt_path.stat().st_size / (1024 * 1024)

    if file_size_mb > max_file_size_mb:
        warnings.append(f"File size {file_size_mb:.2f}MB > {max_file_size_mb}MB")

    return {
        "valid": len(errors) == 0,
        "errors": errors,
        "warnings": warnings,
        "slide_count": actual_count,
        "file_size_mb": round(file_size_mb, 2),
        "slide_width": prs.slide_width,
        "slide_height": prs.slide_height
    }


def generate_quality_report(
    screenshot_validation: Dict,
    ppt_validation: Dict,
    output_file: Optional[Path] = None
) -> str:
    """
    ç”Ÿæˆè´¨é‡éªŒè¯æŠ¥å‘Š

    Args:
        screenshot_validation: æˆªå›¾éªŒè¯ç»“æœ
        ppt_validation: PPTéªŒè¯ç»“æœ
        output_file: è¾“å‡ºæŠ¥å‘Šæ–‡ä»¶è·¯å¾„(å¯é€‰)

    Returns:
        æŠ¥å‘Šæ–‡æœ¬å†…å®¹
    """
    report_lines = [
        "# HTML-to-PPT è´¨é‡éªŒè¯æŠ¥å‘Š",
        "",
        f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        "",
        "## æˆªå›¾è´¨é‡",
        ""
    ]

    # æˆªå›¾éªŒè¯ç»“æœ
    if screenshot_validation['valid']:
        report_lines.append(f"âœ… æˆªå›¾éªŒè¯é€šè¿‡ ({screenshot_validation['valid_count']}/{screenshot_validation['total']})")
    else:
        report_lines.append(f"âœ— æˆªå›¾éªŒè¯å¤±è´¥ ({screenshot_validation['valid_count']}/{screenshot_validation['total']})")

    if screenshot_validation['errors']:
        report_lines.append("\n### é”™è¯¯:")
        for error in screenshot_validation['errors']:
            report_lines.append(f"- {error}")

    if screenshot_validation['warnings']:
        report_lines.append("\n### è­¦å‘Š:")
        for warning in screenshot_validation['warnings']:
            report_lines.append(f"- {warning}")

    # è¯¦ç»†ç»“æœ
    report_lines.append("\n### è¯¦ç»†ç»“æœ:")
    for result in screenshot_validation['results']:
        status = "âœ“" if result['valid'] else "âœ—"
        report_lines.append(f"\n{status} {result['name']}")
        report_lines.append(f"  å°ºå¯¸: {result['width']}x{result['height']}")
        if result['errors']:
            for error in result['errors']:
                report_lines.append(f"  é”™è¯¯: {error}")

    # PPTéªŒè¯ç»“æœ
    report_lines.extend([
        "",
        "## PPTè´¨é‡",
        ""
    ])

    if ppt_validation['valid']:
        report_lines.append("âœ… PPTéªŒè¯é€šè¿‡")
    else:
        report_lines.append("âœ— PPTéªŒè¯å¤±è´¥")

    report_lines.append(f"\n- å¹»ç¯ç‰‡æ•°é‡: {ppt_validation['slide_count']}")
    report_lines.append(f"- æ–‡ä»¶å¤§å°: {ppt_validation['file_size_mb']}MB")
    report_lines.append(f"- å¹»ç¯ç‰‡å°ºå¯¸: {ppt_validation['slide_width']} x {ppt_validation['slide_height']}")

    if ppt_validation['errors']:
        report_lines.append("\n### é”™è¯¯:")
        for error in ppt_validation['errors']:
            report_lines.append(f"- {error}")

    if ppt_validation['warnings']:
        report_lines.append("\n### è­¦å‘Š:")
        for warning in ppt_validation['warnings']:
            report_lines.append(f"- {warning}")

    # æ€»ç»“
    report_lines.extend([
        "",
        "## æ€»ç»“",
        ""
    ])

    if screenshot_validation['valid'] and ppt_validation['valid']:
        report_lines.append("âœ… æ‰€æœ‰è´¨é‡æ£€æŸ¥é€šè¿‡,PPTç”ŸæˆæˆåŠŸ!")
    else:
        report_lines.append("âš ï¸  å‘ç°é—®é¢˜,éœ€è¦è¿”å·¥ä¼˜åŒ–")
        report_lines.append("\nå»ºè®®:")
        if not screenshot_validation['valid']:
            report_lines.append("- æ£€æŸ¥HTMLå†…å®¹æ˜¯å¦æº¢å‡º1080pxé«˜åº¦")
            report_lines.append("- å¢åŠ é¡µé¢åŠ è½½ç­‰å¾…æ—¶é—´")
            report_lines.append("- éªŒè¯è§†å£å°ºå¯¸é…ç½®")
        if not ppt_validation['valid']:
            report_lines.append("- æ£€æŸ¥æˆªå›¾æ–‡ä»¶æ•°é‡")
            report_lines.append("- éªŒè¯PPTå¹»ç¯ç‰‡å°ºå¯¸è®¾ç½®")

    report_text = "\n".join(report_lines)

    if output_file:
        output_file.write_text(report_text, encoding='utf-8')
        print(f"ğŸ“ è´¨é‡æŠ¥å‘Šå·²ä¿å­˜: {output_file}")

    return report_text


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # ç¤ºä¾‹1: ç»„è£…PPT
    result = create_ppt_from_screenshots(
        screenshot_dir=Path("screenshots"),
        output_ppt=Path("output.pptx"),
        title="äº‘å—è¿‡æ¡¥ç±³çº¿è¥é”€æ–¹æ¡ˆ",
        author="ZTLæ•°æ™ºåŒ–ä½œæˆ˜ä¸­å¿ƒ"
    )

    # ç¤ºä¾‹2: éªŒè¯æˆªå›¾
    screenshot_validation = validate_screenshots(
        screenshot_dir=Path("screenshots"),
        expected_width=1920,
        min_height=800
    )

    # ç¤ºä¾‹3: éªŒè¯PPT
    ppt_validation = validate_ppt(
        ppt_path=Path("output.pptx"),
        expected_slide_count=7,
        max_file_size_mb=50.0
    )

    # ç¤ºä¾‹4: ç”ŸæˆæŠ¥å‘Š
    report = generate_quality_report(
        screenshot_validation=screenshot_validation,
        ppt_validation=ppt_validation,
        output_file=Path("quality_report.md")
    )

    print(report)
